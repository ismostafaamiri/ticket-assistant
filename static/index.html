<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Qdrant Search UI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { direction: rtl; text-align: right; background: #f9fafb; }
    .search-box { margin: 2rem auto; max-width: 1000px; }
    .card { margin-bottom: 1rem; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; }
    .card:hover { transform: translateY(-4px); }
    pre { background: #f1f1f1; padding: .5rem; border-radius: .5rem; max-height: 200px; overflow:auto; }

    /* Chat styling */
    .chat-bubble {
      max-width: 85%;
      padding: .6rem .8rem;
      margin-bottom: .5rem;
      border-radius: 1rem;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .chat-user {
      background: #e3f2fd;
      align-self: flex-start;
    }
    .chat-agent {
      background: #f1f8e9;
      align-self: flex-end;
    }
    .chat-meta {
      font-size: .75rem;
      color: #666;
      margin-top: .2rem;
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      gap: .5rem;
    }

    .skeleton-card {
  background: #fff;
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.skeleton {
  background: linear-gradient(90deg, #f0f0f0 25%, #e4e4e4 37%, #f0f0f0 63%);
  background-size: 400% 100%;
  animation: shimmer 1.4s ease infinite;
  border-radius: 4px;
  margin-bottom: 8px;
}

.skeleton-img {
  height: 120px;
  width: 100%;
}

.skeleton-text {
  height: 14px;
  width: 80%;
}

.skeleton-text.short {
  width: 50%;
}

@keyframes shimmer {
  0% { background-position: -400px 0; }
  100% { background-position: 400px 0; }
}
  </style>
</head>
<body>
<div class="container">
  <div class="search-box">
    <h1 class="mb-4 text-center">ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ØªÛŒÚ©Øªâ€ŒÙ‡Ø§</h1>

    <form id="search-form" class="row g-3 align-items-end">
      <div class="row">
        <div class="col-md-5 col-sm-12">
          <label for="query" class="form-label">Ø¹Ø¨Ø§Ø±Øª Ø¬Ø³ØªØ¬Ùˆ</label>
          <input type="text" id="query" class="form-control" placeholder="Ø¹Ø¨Ø§Ø±Øª Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
        </div>

        <!-- Ticket Type -->
        <div class="col-md-3 col-sm-6">
          <label for="ticket_type" class="form-label">Ù†ÙˆØ¹ ØªÛŒÚ©Øª</label>
          <select id="ticket_type" class="form-select">
            <option value="all">Ù‡Ù…Ù‡ Ù†ÙˆØ¹â€ŒÙ‡Ø§</option>
            <option value="Ø±ÙØ¹ Ø¹ÛŒØ¨">Ø±ÙØ¹ Ø¹ÛŒØ¨</option>
            <option value="Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙÙ†ÛŒØŒ ØªØºÛŒÛŒØ± ÙŠØ§ Ø§Ø±ØªÙ‚Ø§Ø¡">Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙÙ†ÛŒØŒ ØªØºÛŒÛŒØ± ÙŠØ§ Ø§Ø±ØªÙ‚Ø§Ø¡</option>
            <option value="Ø§Ø¯Ø§Ø±ÛŒ Ùˆ Ù…Ø§Ù„ÛŒ">Ø§Ø¯Ø§Ø±ÛŒ Ùˆ Ù…Ø§Ù„ÛŒ</option>
            <option value="ÙØ±ÙˆØ´">ÙØ±ÙˆØ´</option>
          </select>
        </div>

        <!-- Attachments Checkbox -->
        <div class="col-md-2 col-sm-6 d-flex align-items-center mt-2 mt-md-0">
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="attachments">
            <label class="form-check-label" for="attachments">Ø¯Ø§Ø±Ø§ÛŒ Ø§Ù„Ø­Ø§Ù‚Ø§Øª</label>
          </div>

        </div>
        <div class="col-md-2 col-sm-6 d-flex align-items-center mt-2 mt-md-0">
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="is_internal">
            <label class="form-check-label" for="is_internal">Ø¯Ø§Ø®Ù„ÛŒ</label>
          </div>
        </div>
      </div>
      <!-- Query -->
      
      <div class="row">
        <div class="col-md-5 col-sm-12">
          <label for="ticket_id" class="form-label">Ø´Ù…Ø§Ø±Ù‡ ØªÛŒÚ©Øª</label>
          <input type="text" id="ticket_id" class="form-control" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÛŒÚ©Øª">
        </div>
        <!-- Date From -->
        <div class="col-md-2 col-sm-6">
          <label for="date_from" class="form-label">Ø§Ø² ØªØ§Ø±ÛŒØ®</label>
          <input type="date" id="date_from" class="form-control">
        </div>

        <!-- Date To -->
        <div class="col-md-2 col-sm-6">
          <label for="date_to" class="form-label">ØªØ§ ØªØ§Ø±ÛŒØ®</label>
          <input type="date" id="date_to" class="form-control">
        </div>
      </div>


      <!-- Search Button -->
      <div>
        <textarea id="true_tickets" rows="2" width="100%" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÛŒÚ©Øª Ù‡Ø§ÛŒ Ø¯Ø±Ø³Øª" class="col-md-12 col-sm-12"></textarea>
      </div>
      <div class="col-md-2 col-sm-12">
        <button type="button" class="btn btn-primary w-100" onclick="search()">Ø¬Ø³ØªØ¬Ùˆ</button>
      </div>
    </form>
    <div id="metrics" class="row mt-4"></div>
    <div id="results" class="row mt-4"></div>
  </div>
</div>

<!-- Chat Modal -->
<div class="modal fade" id="chatModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ğŸ’¬ Ú¯ÙØªâ€ŒÙˆÚ¯Ùˆ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>
      </div>
      <div class="modal-body">
        <div id="chatContainer" class="chat-container"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentChat = [];

function showSkeletons(total = 9) {
  const resultsDiv = document.getElementById("results");
  let skeletonHTML = '';
  const perRow = 3;

  for (let i = 0; i < total; i++) {
    // Start a new row every 3 cards
    if (i % perRow === 0) {
      skeletonHTML += `<div class="row mb-3">`;
    }

    skeletonHTML += `
      <div class="col-md-4 mb-3">
        <div class="skeleton-card">
          <div class="skeleton skeleton-img"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text short"></div>
        </div>
      </div>
    `;

    // Close the row after 3 cards
    if ((i + 1) % perRow === 0) {
      skeletonHTML += `</div>`;
    }
  }

  // In case total is not a multiple of perRow (not needed for 9, but good practice)
  if (total % perRow !== 0) {
    skeletonHTML += `</div>`;
  }

  document.querySelector('#results').innerHTML = skeletonHTML;
}

// Helper functions
function booleanIcon(value, icon) {
  return value ? icon : '';
}

function stateBadge(state) {
  const color = state === "Ø¨Ø§Ø²" ? "success" : "secondary"; // green for open, gray for closed
  return `<span class="badge bg-${color} me-1">${state}</span>`;
}

function categoryBadge(type) {
  let colorClass = "bg-secondary"; // default

  switch (type) {
    case "Ø±ÙØ¹ Ø¹ÛŒØ¨":
      colorClass = "bg-danger"; // red
      break;
    case "Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙÙ†ÛŒØŒ ØªØºÛŒÛŒØ± ÙŠØ§ Ø§Ø±ØªÙ‚Ø§Ø¡":
      colorClass = "bg-info"; // light blue
      break;
    case "Ø§Ø¯Ø§Ø±ÛŒ Ùˆ Ù…Ø§Ù„ÛŒ":
      colorClass = "bg-warning text-dark"; // yellow with dark text
      break;
    case "ÙØ±ÙˆØ´":
      colorClass = "bg-success"; // green
      break;
  }

  return `<span class="badge ${colorClass} me-1">${type}</span>`;
}

function typeBadge(type) {
  return `<span class="badge bg-primary me-1">${type}</span>`;
}

function idBadge(id) {
  return `<span class="badge bg-info me-1">#${id}</span>`;
}

async function search() {
  const q = document.getElementById("query").value;
  const ticket_id = document.getElementById("ticket_id").value;
  const type = document.getElementById("ticket_type").value;
  const attachments = document.getElementById("attachments").checked ? "true" : "false";
  const is_internal = document.getElementById("is_internal").checked ? "true" : "false";
  const fromDate = document.getElementById("date_from").value;
  const toDate = document.getElementById("date_to").value;
  const trueTickets = document.getElementById("true_tickets").value;
  
  const params = new URLSearchParams({
    q,
    request_type: type,
    attachments,
    is_internal,
    ticket_id,
    date_from: fromDate,
    date_to: toDate,
    true_tickets: trueTickets
  });

  showSkeletons(); // show skeleton placeholders
  const res = await fetch(`/search?${params.toString()}`);
  const data = await res.json();
  
  const resultsDiv = document.getElementById("results");
  const metricsDiv = document.getElementById("metrics");
  
  if (data.length === 0) {
    resultsDiv.innerHTML = "<p class='text-center text-muted'>Ù‡ÛŒÚ† Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</p>";
    return;
  }
  metricsDiv.innerHTML = `
  <div class="mb-2">
  Precision@10: ${typeBadge(data.metrics.precision_at_10)}
  </div>
  <div class="mb-2">
  Recall@10: ${typeBadge(data.metrics.Recall_at_10)}
  </div>`
  resultsDiv.innerHTML = "";
  data.results.forEach(item => {
    const col = document.createElement("div");
    col.className = "col-md-6 col-lg-4";

    const card = document.createElement("div");
    card.className = "card";
    card.onclick = () => showChat(item);


    // Build card HTML
    card.innerHTML = `
      <div class="card-body">
        <h5 class="card-title" id="card-title">${item.payload.summary || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</h5>

      <div class="progress mb-2" style="height: 6px;">
        <div 
          class="progress-bar bg-primary" 
          role="progressbar" 
          style="width: ${item.score * 100}%;" 
          aria-valuenow="${item.score * 100}" 
          aria-valuemin="0" 
          aria-valuemax="100">
        </div>
        </div>
        <small class="text-muted">Ø§Ù…ØªÛŒØ§Ø²: ${item.score.toFixed(3)}</small>
        
        <!-- Badges -->
        <div class="mb-2">
          ${stateBadge(item.payload.state)}
          ${categoryBadge(item.payload.request_type)}
          ${typeBadge(item.payload.access)}
          <a href="https://iransamaneh.com/admin/modules/crm/tickets/view.php?id=${item.payload.ticket_id}" target="_blank" class="text-blue-600 underline">
            ${idBadge(item.payload.ticket_id)}
          </a>
        </div>

        <!-- Icons -->
        <div class="mb-2">
          ${booleanIcon(item.payload.attachments, 'ğŸ“')}
          ${booleanIcon(item.payload.is_internal, 'ğŸ—„ï¸')}
        </div>

        <!-- Other fields -->
        <ul class="list-group list-group-flush">
          <li class="list-group-item" style="display: flex;justify-content: space-between;">
            <span>ÙˆØ¶Ø¹ÛŒØª</span>
            <span><strong>${item.payload.state}</strong></span>
          </li >
          <li class="list-group-item" style="display: flex;justify-content: space-between;">
            <span>ØªØ§Ø±ÛŒØ®</span>
            <span><strong>${item.payload.metadata.split("-")[0] || "-"}</strong></span>
          </li >
          <li class="list-group-item" style="display: flex;justify-content: space-between;">
            <span>Ø§Ù‚Ø¯Ø§Ù… Ú©Ù†Ù†Ø¯Ù‡</span>
            <span><strong>${item.payload.actioner || "-"}</strong></span>
          </li >

        </ul>
      </div>
    `;

    col.appendChild(card);
    
    resultsDiv.appendChild(col);
  });

}



function showChat(item) {
  const chat = item.payload?.chat || [];
  const container = document.getElementById("chatContainer");
  container.innerHTML = "";

  if (chat.length === 0) {
    container.innerHTML = "<p class='text-muted text-center'>Ù‡ÛŒÚ† Ú¯ÙØªâ€ŒÙˆÚ¯ÙˆÛŒÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>";
  } else {
    chat.forEach(turn => {
      const metaText = turn["Ù…ØªØ§Ø¯ÛŒØªØ§"] || "";
      const isCustomer = metaText.includes("IS");

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      bubble.style.background = isCustomer ? "#e3f2fd" : "#f1f8e9"; // blue for IS, green for others
      bubble.innerText = turn["Ù…ØªÙ†"];

      const meta = document.createElement("div");
      meta.className = "chat-meta";
      meta.innerText = metaText;

      const wrapper = document.createElement("div");
      wrapper.style.display = "flex";
      wrapper.style.flexDirection = "column";
      wrapper.style.alignItems = isCustomer ? "flex-start" : "flex-end";

      wrapper.appendChild(bubble);
      wrapper.appendChild(meta);
      container.appendChild(wrapper);
    });
  }

  const modal = new bootstrap.Modal(document.getElementById('chatModal'));
  modal.show();
}
</script>

</body>
</html>
